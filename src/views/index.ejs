<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Home - Movie Watchlist</title>
    <link rel="stylesheet" href="/css/style.css" />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;700&display=swap"
      rel="stylesheet"
    />
  </head>
  <body>
    <header>
      <nav>
        <div class="container">
          <a href="/" class="logo">Movie Watchlist</a>
          <ul class="nav-links">
            <li><a href="/" class="active">Home</a></li>
            <li><a href="/history">History</a></li>
            <li><a href="/settings">Settings</a></li>
          </ul>
        </div>
      </nav>
    </header>

    <main class="container">
      <section class="hero">
        <h1>Your Movie Watchlist</h1>
        <p>Discover, track, and review your favorite movies</p>
      </section>

      <section class="action-controls">
        <div class="control-buttons">
          <button id="addMovieBtn" class="btn-primary">
            <span class="btn-icon">+</span>
            Add New Movie
          </button>
          <button id="filterMoviesBtn" class="btn-secondary">
            <span class="btn-icon">üîç</span>
            Filter Movies
          </button>
        </div>

        <div id="addMovieForm" class="form-panel" style="display: none">
          <h3>Add New Movie</h3>

          <!-- Step 1: Search for movie -->
          <div id="searchStep" class="add-movie-step">
            <div class="search-box">
              <input
                type="text"
                id="movieSearchInput"
                placeholder="Search for a movie..."
                autocomplete="off"
              />
              <button type="button" id="searchMovieBtn" class="btn-primary">
                Search
              </button>
              <button type="button" id="cancelSearch" class="btn-secondary">
                Cancel
              </button>
            </div>
            <div id="searchResults" class="search-results"></div>
            <div class="manual-entry-link">
              <button type="button" id="manualEntryBtn" class="btn-link">
                Or enter movie details manually
              </button>
            </div>
          </div>

          <!-- Step 2: Confirm and set desire scale -->
          <div id="confirmStep" class="add-movie-step" style="display: none">
            <div class="selected-movie-card">
              <img id="selectedPoster" class="selected-poster" alt="Movie poster" />
              <div class="selected-info">
                <h4 id="selectedTitle"></h4>
                <p id="selectedYear" class="selected-meta"></p>
                <p id="selectedOverview" class="selected-overview"></p>
              </div>
            </div>

            <form class="movie-form" id="finalAddForm">
              <input type="hidden" name="_csrf" value="<%= csrfToken %>" />
              <input type="hidden" id="tmdbId" />
              <input type="hidden" id="finalTitle" />
              <input type="hidden" id="finalGenre" />
              <input type="hidden" id="posterPath" />
              <input type="hidden" id="overview" />
              <input type="hidden" id="releaseDate" />
              <input type="hidden" id="voteAverage" />

              <div class="form-group">
                <label for="desireScale">How much do you want to watch this?</label>
                <select id="desireScale" required>
                  <option value="">Select desire level</option>
                  <option value="1">‚≠ê - Not very interested</option>
                  <option value="2">‚≠ê‚≠ê - Somewhat interested</option>
                  <option value="3">‚≠ê‚≠ê‚≠ê - Interested</option>
                  <option value="4">‚≠ê‚≠ê‚≠ê‚≠ê - Very interested</option>
                  <option value="5">‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê - Must watch!</option>
                </select>
              </div>

              <div class="form-actions">
                <button type="submit" class="btn-primary">Add to Watchlist</button>
                <button type="button" id="backToSearch" class="btn-secondary">
                  Back to Search
                </button>
                <button type="button" id="cancelAdd" class="btn-secondary">
                  Cancel
                </button>
              </div>
            </form>
          </div>

          <!-- Step 3: Manual entry fallback -->
          <div id="manualStep" class="add-movie-step" style="display: none">
            <form class="movie-form" id="manualAddForm">
              <input type="hidden" name="_csrf" value="<%= csrfToken %>" />
              <div class="form-group">
                <input
                  type="text"
                  id="manualTitle"
                  placeholder="Movie Title"
                  required
                />
                <select id="manualGenre" required>
                  <option value="">Select Genre</option>
                  <option value="action">Action</option>
                  <option value="comedy">Comedy</option>
                  <option value="drama">Drama</option>
                  <option value="horror">Horror</option>
                  <option value="romance">Romance</option>
                  <option value="sci-fi">Sci-Fi</option>
                  <option value="thriller">Thriller</option>
                </select>
                <select id="manualDesire" required>
                  <option value="">Desire to Watch</option>
                  <option value="1">‚≠ê - Not very interested</option>
                  <option value="2">‚≠ê‚≠ê - Somewhat interested</option>
                  <option value="3">‚≠ê‚≠ê‚≠ê - Interested</option>
                  <option value="4">‚≠ê‚≠ê‚≠ê‚≠ê - Very interested</option>
                  <option value="5">‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê - Must watch!</option>
                </select>
                <div class="form-actions">
                  <button type="submit" class="btn-primary">Add Movie</button>
                  <button type="button" id="backToSearchFromManual" class="btn-secondary">
                    Back to Search
                  </button>
                  <button type="button" id="cancelManual" class="btn-secondary">
                    Cancel
                  </button>
                </div>
              </div>
            </form>
          </div>
        </div>

        <div id="filterForm" class="form-panel" style="display: none">
          <h3>Filter Movies</h3>
          <form class="filter-form">
            <div class="form-group">
              <input
                type="text"
                id="filterName"
                placeholder="Search by name..."
              />
              <select id="filterGenre">
                <option value="">All Genres</option>
                <option value="action">Action</option>
                <option value="comedy">Comedy</option>
                <option value="drama">Drama</option>
                <option value="horror">Horror</option>
                <option value="romance">Romance</option>
                <option value="sci-fi">Sci-Fi</option>
                <option value="thriller">Thriller</option>
              </select>
              <select id="filterDesire">
                <option value="">All Desire Levels</option>
                <option value="1">1 - Low</option>
                <option value="2">2</option>
                <option value="3">3 - Medium</option>
                <option value="4">4</option>
                <option value="5">5 - High</option>
              </select>
              <div class="form-actions">
                <button type="button" id="clearFilters" class="btn-secondary">
                  Clear Filters
                </button>
                <button type="button" id="cancelFilter" class="btn-secondary">
                  Cancel
                </button>
              </div>
            </div>
          </form>
        </div>
      </section>

      <section class="watchlist">
        <div class="list-header">
          <h2>Your Watchlist (<%= totalMovies %> movies)</h2>
          <button id="clearList" class="btn-danger">Clear All</button>
        </div>

        <div id="movieList" class="movie-grid">
          <% if (movies && movies.length > 0) { %> <%
          movies.forEach(function(movie) { %>
          <div class="movie-card" data-id="<%= movie.id %>">
            <% if (movie.posterPath) { %>
            <div class="movie-poster-container">
              <img
                src="https://image.tmdb.org/t/p/w300<%= movie.posterPath %>"
                alt="<%= movie.title %> poster"
                class="movie-poster-img"
              />
            </div>
            <% } %>
            <div class="movie-header">
              <h3 class="movie-title"><%= movie.title %></h3>
              <span class="movie-genre"><%= movie.genre %></span>
            </div>
            <% if (movie.overview) { %>
            <div class="movie-overview">
              <%= movie.overview.substring(0, 120) %><%= movie.overview.length > 120 ? '...' : '' %>
            </div>
            <% } %>
            <div class="movie-details">
              <div class="desire-scale">
                <span>Desire to watch:</span>
                <div class="stars">
                  <% for(let i = 1; i <= 5; i++) { %> <%= i <=
                  movie.desireScale ? '‚òÖ' : '‚òÜ' %> <% } %>
                </div>
              </div>
              <div class="watch-date">
                Added: <%= new Date(movie.dateAdded).toLocaleDateString('en-US',
                { year: 'numeric', month: 'short', day: 'numeric', timeZone:
                'UTC' }) %>
              </div>
            </div>
            <div class="movie-actions">
              <button
                class="btn-primary mark-watched-btn"
                data-movie-id="<%= movie.id %>"
              >
                Mark Watched
              </button>
              <button
                class="btn-danger remove-movie-btn"
                data-movie-id="<%= movie.id %>"
              >
                Remove
              </button>
            </div>
          </div>
          <% }); %> <% } else { %>
          <div class="empty-state">
            <h3>No movies in your watchlist yet!</h3>
            <p>Add your first movie above to get started.</p>
          </div>
          <% } %>
        </div>
      </section>
    </main>

    <footer>
      <div class="container">
        <p>&copy; 2025 Movie Watchlist App. All rights reserved.</p>
      </div>
    </footer>

    <script src="/js/main.js"></script>

    <% if (typeof showWelcome !== 'undefined' && showWelcome) { %>
    <script>
      // Wait for the DOM to be loaded so showNotification() is available
      document.addEventListener('DOMContentLoaded', function () {
        // Use the email from the user object
        showNotification('Welcome back, <%= user.email %>!', 'success');
      });
    </script>
    <% } %>
  </body>
</html>
